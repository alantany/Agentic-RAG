#!/usr/bin/env python3
"""
åˆå§‹åŒ–Oracle 23aiæ•°æ®åº“è¡¨ç»“æ„
"""

import oracledb
from oracle_23ai_config import ORACLE_23AI_CONFIG, VECTOR_CONFIG, JSON_CONFIG, GRAPH_CONFIG

def init_oracle_database():
    """åˆå§‹åŒ–Oracle 23aiæ•°æ®åº“"""
    print("ğŸš€ å¼€å§‹åˆå§‹åŒ–Oracle 23aièåˆæ•°æ®åº“...")
    print("=" * 60)
    
    try:
        # è¿æ¥æ•°æ®åº“
        print("ğŸ”— è¿æ¥æ•°æ®åº“...")
        connection = oracledb.connect(
            user=ORACLE_23AI_CONFIG["username"],
            password=ORACLE_23AI_CONFIG["password"],
            dsn=ORACLE_23AI_CONFIG["dsn"]
        )
        
        cursor = connection.cursor()
        print("âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ")
        
        # 1. åˆ›å»ºå‘é‡è¡¨
        print("\nğŸ“Š åˆ›å»ºå‘é‡æ•°æ®è¡¨...")
        vector_ddl = f"""
        CREATE TABLE {VECTOR_CONFIG["table_name"]} (
            id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
            patient_name VARCHAR2(100),
            content CLOB,
            {VECTOR_CONFIG["embedding_column"]} VECTOR({VECTOR_CONFIG["dimension"]}, FLOAT32),
            {VECTOR_CONFIG["metadata_column"]} JSON,
            created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
        """
        
        try:
            cursor.execute(vector_ddl)
            print(f"âœ… {VECTOR_CONFIG['table_name']} è¡¨åˆ›å»ºæˆåŠŸ")
        except Exception as e:
            if "ORA-00955" in str(e):
                print(f"â„¹ï¸ {VECTOR_CONFIG['table_name']} è¡¨å·²å­˜åœ¨")
            else:
                print(f"âŒ {VECTOR_CONFIG['table_name']} è¡¨åˆ›å»ºå¤±è´¥: {str(e)}")
        
        # 2. åˆ›å»ºJSONæ–‡æ¡£è¡¨
        print("\nğŸ“„ åˆ›å»ºJSONæ–‡æ¡£è¡¨...")
        json_ddl = f"""
        CREATE TABLE {JSON_CONFIG["table_name"]} (
            id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
            patient_id VARCHAR2(50),
            {JSON_CONFIG["json_column"]} JSON,
            {JSON_CONFIG["metadata_column"]} JSON,
            created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
        """
        
        try:
            cursor.execute(json_ddl)
            print(f"âœ… {JSON_CONFIG['table_name']} è¡¨åˆ›å»ºæˆåŠŸ")
        except Exception as e:
            if "ORA-00955" in str(e):
                print(f"â„¹ï¸ {JSON_CONFIG['table_name']} è¡¨å·²å­˜åœ¨")
            else:
                print(f"âŒ {JSON_CONFIG['table_name']} è¡¨åˆ›å»ºå¤±è´¥: {str(e)}")
        
        # 3. åˆ›å»ºå›¾é¡¶ç‚¹è¡¨
        print("\nğŸ•¸ï¸ åˆ›å»ºå›¾æ•°æ®è¡¨...")
        vertex_ddl = f"""
        CREATE TABLE {GRAPH_CONFIG["vertex_table"]} (
            vertex_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
            vertex_type VARCHAR2(50),
            vertex_label VARCHAR2(200),
            properties JSON,
            created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
        """
        
        try:
            cursor.execute(vertex_ddl)
            print(f"âœ… {GRAPH_CONFIG['vertex_table']} è¡¨åˆ›å»ºæˆåŠŸ")
        except Exception as e:
            if "ORA-00955" in str(e):
                print(f"â„¹ï¸ {GRAPH_CONFIG['vertex_table']} è¡¨å·²å­˜åœ¨")
            else:
                print(f"âŒ {GRAPH_CONFIG['vertex_table']} è¡¨åˆ›å»ºå¤±è´¥: {str(e)}")
        
        # 4. åˆ›å»ºå›¾è¾¹è¡¨
        edge_ddl = f"""
        CREATE TABLE {GRAPH_CONFIG["edge_table"]} (
            edge_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
            source_vertex_id NUMBER,
            target_vertex_id NUMBER,
            edge_type VARCHAR2(50),
            edge_label VARCHAR2(200),
            properties JSON,
            created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (source_vertex_id) REFERENCES {GRAPH_CONFIG["vertex_table"]}(vertex_id),
            FOREIGN KEY (target_vertex_id) REFERENCES {GRAPH_CONFIG["vertex_table"]}(vertex_id)
        )
        """
        
        try:
            cursor.execute(edge_ddl)
            print(f"âœ… {GRAPH_CONFIG['edge_table']} è¡¨åˆ›å»ºæˆåŠŸ")
        except Exception as e:
            if "ORA-00955" in str(e):
                print(f"â„¹ï¸ {GRAPH_CONFIG['edge_table']} è¡¨å·²å­˜åœ¨")
            else:
                print(f"âŒ {GRAPH_CONFIG['edge_table']} è¡¨åˆ›å»ºå¤±è´¥: {str(e)}")
        
        # 5. åˆ›å»ºå‘é‡ç´¢å¼•
        print("\nğŸ¯ åˆ›å»ºå‘é‡ç´¢å¼•...")
        vector_index_ddl = f"""
        CREATE VECTOR INDEX {VECTOR_CONFIG["table_name"]}_VEC_IDX 
        ON {VECTOR_CONFIG["table_name"]} ({VECTOR_CONFIG["embedding_column"]})
        ORGANIZATION INMEMORY NEIGHBOR GRAPH
        DISTANCE {VECTOR_CONFIG["distance_metric"]}
        WITH TARGET ACCURACY {VECTOR_CONFIG["accuracy"]}
        """
        
        try:
            cursor.execute(vector_index_ddl)
            print(f"âœ… å‘é‡ç´¢å¼•åˆ›å»ºæˆåŠŸ")
        except Exception as e:
            if "ORA-00955" in str(e) or "already exists" in str(e).lower():
                print(f"â„¹ï¸ å‘é‡ç´¢å¼•å·²å­˜åœ¨")
            else:
                print(f"âš ï¸ å‘é‡ç´¢å¼•åˆ›å»ºå¤±è´¥: {str(e)}")
                print("ğŸ’¡ å‘é‡ç´¢å¼•å¯èƒ½éœ€è¦ç‰¹æ®Šæƒé™æˆ–é…ç½®")
        
        # 6. åˆ›å»ºJSONæœç´¢ç´¢å¼•ï¼ˆå¦‚æœå¯ç”¨ï¼‰
        if JSON_CONFIG.get("enable_full_text_search", False):
            print("\nğŸ” åˆ›å»ºJSONæœç´¢ç´¢å¼•...")
            json_index_ddl = f"""
            CREATE SEARCH INDEX {JSON_CONFIG["search_index"]} 
            ON {JSON_CONFIG["table_name"]} ({JSON_CONFIG["json_column"]})
            FOR JSON
            """
            
            try:
                cursor.execute(json_index_ddl)
                print(f"âœ… JSONæœç´¢ç´¢å¼•åˆ›å»ºæˆåŠŸ")
            except Exception as e:
                if "ORA-00955" in str(e) or "already exists" in str(e).lower():
                    print(f"â„¹ï¸ JSONæœç´¢ç´¢å¼•å·²å­˜åœ¨")
                else:
                    print(f"âš ï¸ JSONæœç´¢ç´¢å¼•åˆ›å»ºå¤±è´¥: {str(e)}")
                    print("ğŸ’¡ JSONæœç´¢ç´¢å¼•å¯èƒ½éœ€è¦Oracle Textç»„ä»¶")
        
        # æäº¤äº‹åŠ¡
        connection.commit()
        
        # 7. éªŒè¯è¡¨ç»“æ„
        print("\nğŸ“‹ éªŒè¯è¡¨ç»“æ„...")
        cursor.execute("SELECT table_name FROM user_tables ORDER BY table_name")
        tables = cursor.fetchall()
        
        print("å·²åˆ›å»ºçš„è¡¨:")
        for table in tables:
            print(f"  - {table[0]}")
        
        # 8. æµ‹è¯•åŸºæœ¬åŠŸèƒ½
        print("\nğŸ§ª æµ‹è¯•åŸºæœ¬åŠŸèƒ½...")
        
        # æµ‹è¯•å‘é‡æ’å…¥
        try:
            test_vector = [0.1, 0.2, 0.3] + [0.0] * 381  # 384ç»´å‘é‡
            cursor.execute(f"""
                INSERT INTO {VECTOR_CONFIG["table_name"]} 
                (patient_name, content, {VECTOR_CONFIG["embedding_column"]}, {VECTOR_CONFIG["metadata_column"]})
                VALUES ('æµ‹è¯•æ‚£è€…', 'æµ‹è¯•å†…å®¹', VECTOR(:1, 384, FLOAT32), JSON('{{"test": true}}'))
            """, [test_vector])
            
            print("  âœ… å‘é‡æ•°æ®æ’å…¥æµ‹è¯•æˆåŠŸ")
            
            # æµ‹è¯•å‘é‡æŸ¥è¯¢
            cursor.execute(f"""
                SELECT patient_name, 
                       VECTOR_DISTANCE({VECTOR_CONFIG["embedding_column"]}, VECTOR(:1, 384, FLOAT32), COSINE) as distance
                FROM {VECTOR_CONFIG["table_name"]}
                WHERE patient_name = 'æµ‹è¯•æ‚£è€…'
            """, [test_vector])
            
            result = cursor.fetchone()
            if result:
                print(f"  âœ… å‘é‡ç›¸ä¼¼åº¦æŸ¥è¯¢æµ‹è¯•æˆåŠŸï¼Œè·ç¦»: {result[1]:.6f}")
            
        except Exception as e:
            print(f"  âš ï¸ å‘é‡åŠŸèƒ½æµ‹è¯•å¤±è´¥: {str(e)}")
        
        # æµ‹è¯•JSONæ’å…¥
        try:
            cursor.execute(f"""
                INSERT INTO {JSON_CONFIG["table_name"]} 
                (patient_id, {JSON_CONFIG["json_column"]}, {JSON_CONFIG["metadata_column"]})
                VALUES ('TEST001', JSON('{{"name": "æµ‹è¯•æ‚£è€…", "age": 30}}'), JSON('{{"source": "test"}}'))
            """)
            
            print("  âœ… JSONæ•°æ®æ’å…¥æµ‹è¯•æˆåŠŸ")
            
            # æµ‹è¯•JSONæŸ¥è¯¢
            cursor.execute(f"""
                SELECT patient_id, JSON_VALUE({JSON_CONFIG["json_column"]}, '$.name') as name
                FROM {JSON_CONFIG["table_name"]}
                WHERE patient_id = 'TEST001'
            """)
            
            result = cursor.fetchone()
            if result:
                print(f"  âœ… JSONæŸ¥è¯¢æµ‹è¯•æˆåŠŸï¼Œæ‚£è€…å: {result[1]}")
            
        except Exception as e:
            print(f"  âš ï¸ JSONåŠŸèƒ½æµ‹è¯•å¤±è´¥: {str(e)}")
        
        # æµ‹è¯•å›¾æ•°æ®æ’å…¥
        try:
            # æ’å…¥é¡¶ç‚¹
            cursor.execute(f"""
                INSERT INTO {GRAPH_CONFIG["vertex_table"]} 
                (vertex_type, vertex_label, properties)
                VALUES ('patient', 'æµ‹è¯•æ‚£è€…', JSON('{{"name": "æµ‹è¯•æ‚£è€…"}}'))
                RETURNING vertex_id INTO :vertex_id
            """, vertex_id_var := cursor.var(int))
            
            vertex_id = vertex_id_var.getvalue()[0]
            print(f"  âœ… å›¾é¡¶ç‚¹æ’å…¥æµ‹è¯•æˆåŠŸï¼Œé¡¶ç‚¹ID: {vertex_id}")
            
        except Exception as e:
            print(f"  âš ï¸ å›¾æ•°æ®åŠŸèƒ½æµ‹è¯•å¤±è´¥: {str(e)}")
        
        # æ¸…ç†æµ‹è¯•æ•°æ®
        print("\nğŸ§¹ æ¸…ç†æµ‹è¯•æ•°æ®...")
        try:
            cursor.execute(f"DELETE FROM {VECTOR_CONFIG['table_name']} WHERE patient_name = 'æµ‹è¯•æ‚£è€…'")
            cursor.execute(f"DELETE FROM {JSON_CONFIG['table_name']} WHERE patient_id = 'TEST001'")
            cursor.execute(f"DELETE FROM {GRAPH_CONFIG['vertex_table']} WHERE vertex_label = 'æµ‹è¯•æ‚£è€…'")
            connection.commit()
            print("  âœ… æµ‹è¯•æ•°æ®æ¸…ç†å®Œæˆ")
        except Exception as e:
            print(f"  âš ï¸ æµ‹è¯•æ•°æ®æ¸…ç†å¤±è´¥: {str(e)}")
        
        cursor.close()
        connection.close()
        
        print("\nğŸ‰ Oracle 23aièåˆæ•°æ®åº“åˆå§‹åŒ–å®Œæˆï¼")
        print("\nğŸ¯ ä¸‹ä¸€æ­¥:")
        print("  1. å¯åŠ¨åº”ç”¨: streamlit run oracle_agentic_rag_demo.py")
        print("  2. ä¸Šä¼ PDFæ–‡æ¡£è¿›è¡Œæµ‹è¯•")
        print("  3. ä½“éªŒç»Ÿä¸€çš„å‘é‡ã€JSONã€å›¾æ•°æ®åº“åŠŸèƒ½")
        
        return True
        
    except Exception as e:
        print(f"âŒ æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥: {str(e)}")
        return False

if __name__ == "__main__":
    success = init_oracle_database()
    if success:
        print("\nâœ… åˆå§‹åŒ–æˆåŠŸï¼å¯ä»¥å¼€å§‹ä½¿ç”¨Oracle 23ai Agentic RAGç³»ç»Ÿ")
    else:
        print("\nâŒ åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯")
