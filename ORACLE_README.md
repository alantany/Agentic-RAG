# Oracle 23ai Agentic RAG 医疗知识问答系统

基于Oracle 23ai融合数据库的智能医疗问答系统，统一管理向量搜索、JSON文档和图数据库。

## 🚀 系统特性

### Oracle 23ai 融合数据库优势
- **统一数据管理**: 一个数据库管理所有数据类型
- **ACID事务**: 跨数据类型的事务一致性
- **性能优化**: 内置优化器，无需多数据库同步
- **简化架构**: 减少系统复杂性和维护成本

### 核心功能
- 🔍 **AI向量搜索**: Oracle AI Vector Search，支持语义搜索
- 📄 **JSON文档存储**: Oracle JSON，原生JSON支持
- 🕸️ **图数据库**: Oracle Graph，支持复杂关系查询
- 🤖 **智能问答**: 基于LLM的医疗知识问答
- 📊 **统一管理**: 集中式数据管理和监控

## 🏗️ 系统架构

```
┌─────────────────────────────────────────────────────────┐
│                 Streamlit 前端界面                        │
├─────────────────────────────────────────────────────────┤
│                 Agentic RAG 核心逻辑                      │
├─────────────────────────────────────────────────────────┤
│                Oracle 23ai 融合数据库                     │
│  ┌─────────────┬─────────────────┬─────────────────────┐ │
│  │ AI Vector   │   JSON Documents │    Graph Database   │ │
│  │   Search    │                 │                     │ │
│  │             │                 │                     │ │
│  │ • 语义搜索   │ • 结构化存储      │ • 关系查询           │ │
│  │ • 相似度计算 │ • 全文检索       │ • 图遍历             │ │
│  │ • 向量索引   │ • JSON查询       │ • PGQL支持          │ │
│  └─────────────┴─────────────────┴─────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

## 📋 环境要求

### 数据库环境
- Oracle Database 23ai (23.4.0+)
- Oracle Instant Client 23c
- 支持AI Vector Search、JSON和Graph功能

### Python环境
- Python 3.8+
- 详见 `oracle_requirements.txt`

## 🛠️ 安装部署

### 1. 安装Oracle 23ai

#### 本地开发环境
```bash
# 下载Oracle 23ai Free
# https://www.oracle.com/database/free/

# 或使用Docker
docker pull container-registry.oracle.com/database/free:23.4.0.24.05
docker run -d --name oracle23ai \
  -p 1521:1521 -p 5500:5500 \
  -e ORACLE_PWD=YourPassword \
  container-registry.oracle.com/database/free:23.4.0.24.05
```

#### Oracle Cloud环境
```bash
# 创建Oracle Autonomous Database
# 选择版本：23ai
# 启用功能：AI Vector Search, JSON, Graph
```

### 2. 安装Python依赖

```bash
# 克隆项目
git clone https://github.com/alantany/Agentic-RAG.git
cd Agentic-RAG
git checkout oracle-23ai-migration

# 安装依赖
pip install -r oracle_requirements.txt
```

### 3. 配置数据库连接

编辑 `oracle_23ai_config.py`:

```python
ORACLE_23AI_CONFIG = {
    "username": "AGENTIC_RAG",
    "password": "your_password",
    "dsn": "localhost:1521/FREEPDB1",  # 本地环境
    # "dsn": "your_cloud_instance.oraclecloud.com:1521/your_service",  # 云环境
    "config_dir": "./oracle_config",
    "wallet_location": "./oracle_wallet",  # 云端连接需要
}
```

### 4. 初始化数据库

```bash
# 运行初始化脚本
python oracle_23ai_config.py
```

### 5. 启动应用

```bash
streamlit run oracle_agentic_rag_demo.py
```

## 📊 数据库结构

### 向量表 (MEDICAL_VECTORS)
```sql
CREATE TABLE MEDICAL_VECTORS (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    patient_name VARCHAR2(100),
    content CLOB,
    vector_data VECTOR(384, FLOAT32),
    metadata JSON,
    created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 向量索引
CREATE VECTOR INDEX MEDICAL_VECTORS_VEC_IDX 
ON MEDICAL_VECTORS (vector_data)
ORGANIZATION INMEMORY NEIGHBOR GRAPH
DISTANCE COSINE
WITH TARGET ACCURACY 95;
```

### JSON文档表 (MEDICAL_DOCUMENTS)
```sql
CREATE TABLE MEDICAL_DOCUMENTS (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    patient_id VARCHAR2(50),
    doc_data JSON,
    doc_metadata JSON,
    created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- JSON搜索索引
CREATE SEARCH INDEX MEDICAL_DOC_IDX 
ON MEDICAL_DOCUMENTS (doc_data)
FOR JSON;
```

### 图数据表
```sql
-- 顶点表
CREATE TABLE MEDICAL_VERTICES (
    vertex_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    vertex_type VARCHAR2(50),
    vertex_label VARCHAR2(200),
    properties JSON,
    created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 边表
CREATE TABLE MEDICAL_EDGES (
    edge_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    source_vertex_id NUMBER,
    target_vertex_id NUMBER,
    edge_type VARCHAR2(50),
    edge_label VARCHAR2(200),
    properties JSON,
    created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (source_vertex_id) REFERENCES MEDICAL_VERTICES(vertex_id),
    FOREIGN KEY (target_vertex_id) REFERENCES MEDICAL_VERTICES(vertex_id)
);
```

## 🔍 查询示例

### 向量搜索
```python
# 语义相似性搜索
results = oracle_vector_store.search_similar_vectors(
    query_text="头痛症状",
    top_k=5,
    patient_filter="周某某"
)
```

### JSON文档查询
```python
# JSON路径查询
cursor.execute("""
    SELECT patient_id, JSON_VALUE(doc_data, '$.患者姓名') as name
    FROM MEDICAL_DOCUMENTS
    WHERE JSON_VALUE(doc_data, '$.主诉') LIKE '%头痛%'
""")
```

### 图数据库查询
```python
# 图遍历查询
traversal_result = oracle_graph_store.graph_traversal(
    start_vertex_id=patient_vertex_id,
    edge_types=["has_complaint", "has_lab_result"],
    max_depth=2
)
```

## 🚀 性能优化

### 向量搜索优化
- 使用IVF或HNSW索引
- 调整accuracy参数平衡精度和性能
- 合理设置向量维度

### JSON查询优化
- 创建函数索引优化常用查询路径
- 使用JSON_VALUE而非JSON_QUERY提升性能
- 启用全文搜索索引

### 图查询优化
- 合理设计顶点和边的索引
- 限制图遍历深度避免性能问题
- 使用PGQL优化复杂图查询

## 🔧 配置选项

### 向量配置
```python
VECTOR_CONFIG = {
    "dimension": 384,
    "distance_metric": "COSINE",  # COSINE, EUCLIDEAN, DOT_PRODUCT
    "vector_index_type": "IVF",   # IVF, HNSW
    "accuracy": 95,
    "neighbors": 50
}
```

### JSON配置
```python
JSON_CONFIG = {
    "enable_full_text_search": True,
    "search_index": "MEDICAL_DOC_IDX"
}
```

### 图配置
```python
GRAPH_CONFIG = {
    "enable_pgql": True,
    "enable_analytics": True
}
```

## 📈 监控和维护

### 性能监控
- 查询执行计划分析
- 索引使用情况监控
- 内存和存储使用监控

### 数据维护
- 定期更新统计信息
- 索引重建和优化
- 数据归档和清理

## 🆚 与多数据库版本对比

| 特性 | Oracle 23ai版本 | 多数据库版本 |
|------|----------------|-------------|
| 数据一致性 | ACID事务保证 | 最终一致性 |
| 运维复杂度 | 低（单数据库） | 高（多数据库） |
| 性能优化 | 统一优化器 | 分别优化 |
| 扩展性 | 垂直扩展为主 | 水平扩展友好 |
| 技术栈 | Oracle生态 | 多技术栈 |
| 学习成本 | 中等 | 较高 |

## 🤝 贡献指南

1. Fork项目到个人账户
2. 创建特性分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 创建Pull Request

## 📄 许可证

本项目采用 MIT 许可证 - 详见 [LICENSE](LICENSE) 文件

## 👥 作者

- **Huaiyuan Tan** - *初始开发* - [alantany](https://github.com/alantany)

## 🙏 致谢

- Oracle 23ai团队提供的融合数据库技术
- Streamlit社区的Web应用框架
- OpenAI提供的大语言模型API
- 所有贡献者和测试用户

## 📞 支持

如有问题或建议，请通过以下方式联系：

- 提交GitHub Issue
- 发送邮件至项目维护者
- 参与项目讨论区

---

**注意**: 这是Oracle 23ai融合数据库版本，需要Oracle 23ai环境支持。如需多数据库版本，请切换到main分支。
