"""
Oracle 23ai èåˆæ•°æ®åº“é…ç½®
ç»Ÿä¸€ç®¡ç†å‘é‡ã€JSONæ–‡æ¡£å’Œå›¾æ•°æ®
"""

import os
from typing import Dict, Any, List, Optional
import oracledb
import json

# Oracle 23ai æ•°æ®åº“é…ç½®
ORACLE_23AI_CONFIG = {
    "username": "AGENTIC_RAG",
    "password": "your_password_here",  # éœ€è¦ç”¨æˆ·æä¾›
    "dsn": "localhost:1521/FREEPDB1",  # æœ¬åœ°Oracle 23ai Free
    # "dsn": "your_cloud_instance.oraclecloud.com:1521/your_service",  # Oracle Cloud
    "config_dir": "./oracle_config",  # Oracleå®¢æˆ·ç«¯é…ç½®ç›®å½•
    "wallet_location": "./oracle_wallet",  # é’±åŒ…ä½ç½®ï¼ˆäº‘ç«¯è¿æ¥ï¼‰
    "pool_min": 2,
    "pool_max": 10,
    "pool_increment": 1,
    "encoding": "UTF-8"
}

# å‘é‡æœç´¢é…ç½®
VECTOR_CONFIG = {
    "dimension": 384,  # ä¸sentence-transformersæ¨¡å‹åŒ¹é…
    "distance_metric": "COSINE",  # COSINE, EUCLIDEAN, DOT_PRODUCT
    "vector_index_type": "IVF",  # IVF, HNSW
    "accuracy": 95,  # æœç´¢ç²¾åº¦ç™¾åˆ†æ¯”
    "neighbors": 50,  # è¿”å›çš„æœ€è¿‘é‚»æ•°é‡
    "table_name": "MEDICAL_VECTORS",
    "embedding_column": "VECTOR_DATA",
    "metadata_column": "METADATA"
}

# JSONæ–‡æ¡£é…ç½®
JSON_CONFIG = {
    "table_name": "MEDICAL_DOCUMENTS",
    "json_column": "DOC_DATA",
    "metadata_column": "DOC_METADATA",
    "search_index": "MEDICAL_DOC_IDX",
    "enable_full_text_search": True
}

# å›¾æ•°æ®åº“é…ç½®
GRAPH_CONFIG = {
    "graph_name": "MEDICAL_KNOWLEDGE_GRAPH",
    "vertex_table": "MEDICAL_VERTICES",
    "edge_table": "MEDICAL_EDGES",
    "enable_pgql": True,  # å¯ç”¨PGQLæŸ¥è¯¢è¯­è¨€
    "enable_analytics": True  # å¯ç”¨å›¾åˆ†æåŠŸèƒ½
}

class Oracle23AIManager:
    """Oracle 23ai èåˆæ•°æ®åº“ç®¡ç†å™¨"""
    
    def __init__(self):
        self.connection_pool = None
        self.connection = None
        
    def initialize_connection_pool(self):
        """åˆå§‹åŒ–è¿æ¥æ± """
        try:
            # åˆå§‹åŒ–Oracleå®¢æˆ·ç«¯
            oracledb.init_oracle_client(
                config_dir=ORACLE_23AI_CONFIG["config_dir"]
            )
            
            # åˆ›å»ºè¿æ¥æ± 
            self.connection_pool = oracledb.create_pool(
                user=ORACLE_23AI_CONFIG["username"],
                password=ORACLE_23AI_CONFIG["password"],
                dsn=ORACLE_23AI_CONFIG["dsn"],
                min=ORACLE_23AI_CONFIG["pool_min"],
                max=ORACLE_23AI_CONFIG["pool_max"],
                increment=ORACLE_23AI_CONFIG["pool_increment"],
                encoding=ORACLE_23AI_CONFIG["encoding"]
            )
            
            print("âœ… Oracle 23aiè¿æ¥æ± åˆå§‹åŒ–æˆåŠŸ")
            return True
            
        except Exception as e:
            print(f"âŒ Oracle 23aiè¿æ¥æ± åˆå§‹åŒ–å¤±è´¥: {str(e)}")
            return False
    
    def get_connection(self):
        """è·å–æ•°æ®åº“è¿æ¥"""
        if self.connection_pool:
            return self.connection_pool.acquire()
        return None
    
    def setup_database_schema(self):
        """è®¾ç½®æ•°æ®åº“æ¨¡å¼å’Œè¡¨ç»“æ„"""
        connection = self.get_connection()
        if not connection:
            return False
            
        try:
            cursor = connection.cursor()
            
            # 1. åˆ›å»ºå‘é‡è¡¨
            vector_ddl = f"""
            CREATE TABLE {VECTOR_CONFIG["table_name"]} (
                id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                patient_name VARCHAR2(100),
                content CLOB,
                {VECTOR_CONFIG["embedding_column"]} VECTOR({VECTOR_CONFIG["dimension"]}, FLOAT32),
                {VECTOR_CONFIG["metadata_column"]} JSON,
                created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
            """
            
            # 2. åˆ›å»ºJSONæ–‡æ¡£è¡¨
            json_ddl = f"""
            CREATE TABLE {JSON_CONFIG["table_name"]} (
                id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                patient_id VARCHAR2(50),
                {JSON_CONFIG["json_column"]} JSON,
                {JSON_CONFIG["metadata_column"]} JSON,
                created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
            """
            
            # 3. åˆ›å»ºå›¾é¡¶ç‚¹è¡¨
            vertex_ddl = f"""
            CREATE TABLE {GRAPH_CONFIG["vertex_table"]} (
                vertex_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                vertex_type VARCHAR2(50),
                vertex_label VARCHAR2(200),
                properties JSON,
                created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
            """
            
            # 4. åˆ›å»ºå›¾è¾¹è¡¨
            edge_ddl = f"""
            CREATE TABLE {GRAPH_CONFIG["edge_table"]} (
                edge_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                source_vertex_id NUMBER,
                target_vertex_id NUMBER,
                edge_type VARCHAR2(50),
                edge_label VARCHAR2(200),
                properties JSON,
                created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (source_vertex_id) REFERENCES {GRAPH_CONFIG["vertex_table"]}(vertex_id),
                FOREIGN KEY (target_vertex_id) REFERENCES {GRAPH_CONFIG["vertex_table"]}(vertex_id)
            )
            """
            
            # æ‰§è¡ŒDDLè¯­å¥
            ddl_statements = [
                ("å‘é‡è¡¨", vector_ddl),
                ("JSONæ–‡æ¡£è¡¨", json_ddl),
                ("å›¾é¡¶ç‚¹è¡¨", vertex_ddl),
                ("å›¾è¾¹è¡¨", edge_ddl)
            ]
            
            for name, ddl in ddl_statements:
                try:
                    cursor.execute(ddl)
                    print(f"âœ… {name}åˆ›å»ºæˆåŠŸ")
                except Exception as e:
                    if "ORA-00955" in str(e):  # è¡¨å·²å­˜åœ¨
                        print(f"â„¹ï¸ {name}å·²å­˜åœ¨")
                    else:
                        print(f"âŒ {name}åˆ›å»ºå¤±è´¥: {str(e)}")
            
            # 5. åˆ›å»ºå‘é‡ç´¢å¼•
            vector_index_ddl = f"""
            CREATE VECTOR INDEX {VECTOR_CONFIG["table_name"]}_VEC_IDX 
            ON {VECTOR_CONFIG["table_name"]} ({VECTOR_CONFIG["embedding_column"]})
            ORGANIZATION INMEMORY NEIGHBOR GRAPH
            DISTANCE {VECTOR_CONFIG["distance_metric"]}
            WITH TARGET ACCURACY {VECTOR_CONFIG["accuracy"]}
            """
            
            try:
                cursor.execute(vector_index_ddl)
                print("âœ… å‘é‡ç´¢å¼•åˆ›å»ºæˆåŠŸ")
            except Exception as e:
                if "ORA-00955" in str(e):
                    print("â„¹ï¸ å‘é‡ç´¢å¼•å·²å­˜åœ¨")
                else:
                    print(f"âŒ å‘é‡ç´¢å¼•åˆ›å»ºå¤±è´¥: {str(e)}")
            
            # 6. åˆ›å»ºJSONæœç´¢ç´¢å¼•
            if JSON_CONFIG["enable_full_text_search"]:
                json_index_ddl = f"""
                CREATE SEARCH INDEX {JSON_CONFIG["search_index"]} 
                ON {JSON_CONFIG["table_name"]} ({JSON_CONFIG["json_column"]})
                FOR JSON
                """
                
                try:
                    cursor.execute(json_index_ddl)
                    print("âœ… JSONæœç´¢ç´¢å¼•åˆ›å»ºæˆåŠŸ")
                except Exception as e:
                    if "ORA-00955" in str(e):
                        print("â„¹ï¸ JSONæœç´¢ç´¢å¼•å·²å­˜åœ¨")
                    else:
                        print(f"âŒ JSONæœç´¢ç´¢å¼•åˆ›å»ºå¤±è´¥: {str(e)}")
            
            connection.commit()
            return True
            
        except Exception as e:
            print(f"âŒ æ•°æ®åº“æ¨¡å¼è®¾ç½®å¤±è´¥: {str(e)}")
            connection.rollback()
            return False
            
        finally:
            connection.close()
    
    def test_connection(self):
        """æµ‹è¯•æ•°æ®åº“è¿æ¥"""
        connection = self.get_connection()
        if not connection:
            return False
            
        try:
            cursor = connection.cursor()
            cursor.execute("SELECT BANNER FROM V$VERSION WHERE ROWNUM = 1")
            version = cursor.fetchone()[0]
            print(f"âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ: {version}")
            return True
            
        except Exception as e:
            print(f"âŒ æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥: {str(e)}")
            return False
            
        finally:
            connection.close()

# å…¨å±€ç®¡ç†å™¨å®ä¾‹
oracle_manager = Oracle23AIManager()

def get_oracle_config():
    """è·å–Oracleé…ç½®"""
    return ORACLE_23AI_CONFIG

def get_vector_config():
    """è·å–å‘é‡é…ç½®"""
    return VECTOR_CONFIG

def get_json_config():
    """è·å–JSONé…ç½®"""
    return JSON_CONFIG

def get_graph_config():
    """è·å–å›¾é…ç½®"""
    return GRAPH_CONFIG

def initialize_oracle_23ai():
    """åˆå§‹åŒ–Oracle 23aiç¯å¢ƒ"""
    print("ğŸš€ å¼€å§‹åˆå§‹åŒ–Oracle 23aièåˆæ•°æ®åº“...")
    
    # åˆå§‹åŒ–è¿æ¥æ± 
    if not oracle_manager.initialize_connection_pool():
        return False
    
    # æµ‹è¯•è¿æ¥
    if not oracle_manager.test_connection():
        return False
    
    # è®¾ç½®æ•°æ®åº“æ¨¡å¼
    if not oracle_manager.setup_database_schema():
        return False
    
    print("âœ… Oracle 23aièåˆæ•°æ®åº“åˆå§‹åŒ–å®Œæˆï¼")
    return True

if __name__ == "__main__":
    # æµ‹è¯•é…ç½®
    print("Oracle 23aièåˆæ•°æ®åº“é…ç½®æµ‹è¯•")
    print("=" * 50)
    
    print("ğŸ“Š é…ç½®ä¿¡æ¯:")
    print(f"  å‘é‡ç»´åº¦: {VECTOR_CONFIG['dimension']}")
    print(f"  è·ç¦»åº¦é‡: {VECTOR_CONFIG['distance_metric']}")
    print(f"  JSONè¡¨å: {JSON_CONFIG['table_name']}")
    print(f"  å›¾åç§°: {GRAPH_CONFIG['graph_name']}")
    
    # æ³¨æ„ï¼šå®é™…è¿è¡Œéœ€è¦å…ˆé…ç½®æ•°æ®åº“è¿æ¥ä¿¡æ¯
    print("\nâš ï¸  è¯·åœ¨å®é™…ä½¿ç”¨å‰é…ç½®æ•°æ®åº“è¿æ¥ä¿¡æ¯")
